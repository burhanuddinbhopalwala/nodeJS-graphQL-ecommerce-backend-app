'use strict';

//* Setting up default NODE_ENV
process.env.ENV = process.env.ENV || 'dev';
process.env.NODE_ENV = process.env.NODE_ENV || 'development';
console.log(`app starting in ${process.env.NODE_ENV} mode`);

const fs = require('fs');
const path = require('path');

const express = require('express');
const morgan = require('morgan');
const xssClean = require('xss-clean');
const helmet = require('helmet');
const rateLimiter = require('express-rate-limit');
const csurf = require('csurf');
const cookieParser = require('cookie-parser');
const bodyParser = require('body-parser');
const expressGraphQL = require('express-graphql');
const swaggerJsDoc = require('swagger-jsdoc');
const swaggerUiExpress = require('swagger-ui-express');
//* https://bundlephobia.com

const { SOURCE } = require(path.join(__dirname, 'constants.js'));
const sequelize = require(path.join(SOURCE, 'models')).sequelize;
const apiV1Auth = require(path.join(
    SOURCE,
    'customMiddlewares',
    'api',
    'v1',
    'isAuth.js'
));
const apiV1UsersRoutes = require(path.join(
    SOURCE,
    'routes',
    'api',
    'v1',
    'users.js'
));
const apiV1ProductsRoutes = require(path.join(
    SOURCE,
    'routes',
    'api',
    'v1',
    'products.js'
));
const apiV1CartsRoutes = require(path.join(
    SOURCE,
    'routes',
    'api',
    'v1',
    'carts.js'
));
const apiV1ShippingAddressesRoutes = require(path.join(
    SOURCE,
    'routes',
    'api',
    'v1',
    'shippingAddresses.js'
));
const apiV1OrdersRoutes = require(path.join(
    SOURCE,
    'routes',
    'api',
    'v1',
    'orders.js'
));
const apiV1GraphQLSchema = require(path.join(
    SOURCE,
    'graphQL',
    'api',
    'v1',
    'schema.js'
));
const apiV1GraphQLResolvers = require(path.join(
    SOURCE,
    'graphQL',
    'api',
    'v1',
    'resolvers.js'
));
const errorHandlingRoutes = require(path.join(
    SOURCE,
    'routes',
    'public',
    'errors.js'
));

const masterJobs = require(path.join(SOURCE, 'jobs', 'masterJobs.js'));

const app = express();
const PORT = process.env.PORT || 3500;

app.set('trust proxy', 1);
//* https://expressjs.com/en/guide/behind-proxies.html
//* If behind a reverse proxy server such as nginx, the trust proxy option must be set.
//* https://medium.com/@sevcsik/authentication-using-https-client-certificates-3c9d270e8326
//* https://nordicapis.com/the-difference-between-http-auth-api-keys-and-oauth/
//* https://salesforce.stackexchange.com/questions/93887/mutual-authentication-two-way-ssl-oauth
//* https://nevatech.com/blog/post/What-you-need-to-know-about-securing-APIs-with-mutual-certificates
//* https://stackoverflow.com/questions/29636715/oauth-2-0-two-legged-authentication-vs-ssl-tls

//* Logging
//* Distributed tracing: https://blog.risingstack.com/node-js-logging-tutorial
const accessLogStream = fs.createWriteStream(
    path.join(SOURCE, 'logs', 'access.log'),
    { flags: 'a' }
);

//* API rate limiter
const apiRateLimiter = rateLimiter({
    max: 1000, //* limit each IP to 100 requests per windowMs
    windowMs: 1 * 1 * 1000, //* 1 sec, min * sec * 1000
    message: 'Too many requests' //* message to send
});

//! CSRF Attacks
const csrfProtection = csurf({
    cookie: true
});

//* Security Middlewares
app.use(morgan('combined', { stream: accessLogStream })); //* Logging
app.use('/api', apiRateLimiter); //! DoS Attacks + Brute Force Attacks
app.use(express.json({ limit: '10kb' })); //! Body limit is 10 - DoS Attacks
app.use(xssClean()); //! Data (HTML & JS-Scripts ) Sanitization against - XSS Attacks
app.use(helmet()); //! XSS Attacks
//! No SQL Sequelize RAW Queries - SQL Injection Attacks
//* https://itnext.io/make-security-on-your-nodejs-api-the-priority-50da8dc71d68

//* Other Middlewares
app.use(/\/((?!graphql).)*/, bodyParser.urlencoded({ extended: true }));
app.use(/\/((?!graphql).)*/, bodyParser.json());
app.use(cookieParser()); //* // We need this because "cookie" is true in csrfProtection
if (process.env.NODE_ENV === 'production') app.use(csrfProtection); //* _csrf, req.csrfToken() + req.body._csrf
// app.all("*", function(req, res) {
//     res.cookie("XSRF-TOKEN", req.csrfToken());
// }); //* SPA
//* err.code === "EBADCSRFTOKEN"
//! CSRF Attacks
app.use((req, res, next) => {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader(
        'Access-Control-Allow-Methods',
        'OPTIONS, GET, POST, PUT, PATCH, DELETE'
    );
    res.setHeader(
        'Access-Control-Allow-Headers',
        'Content-Type, Authorization'
    );
    next();
});

//* For ALB Health Check!
app.get('/api/health', (req, res, next) => {
    const status = 200;
    const uptimeSeconds = process.uptime();
    const uptime =
        Math.floor(uptimeSeconds / (3600 * 24)) +
        ' days ' +
        Math.floor((uptimeSeconds % (3600 * 24)) / 3600) +
        ' hours ' +
        Math.floor((uptimeSeconds % 3600) / 60) +
        ' minutes ' +
        Math.floor(uptimeSeconds % 60) +
        ' seconds';
    res.status(status).json({
        status,
        message: 'Up...',
        data: {
            uptime: uptime,
            timestamp: new Date().toString()
        }
    });
});

//* Buisness routes
app.use('/api/v1/users', apiV1UsersRoutes);
app.use('/api/v1/products', apiV1ProductsRoutes);
app.use('/api/v1/carts', apiV1CartsRoutes);
app.use('/api/v1/shippingAddresses', apiV1ShippingAddressesRoutes);
app.use('/api/v1/orders', apiV1OrdersRoutes);

//* Only for graphQL
//! Don't use custom productValidator here, as graphQL query will not resolve, leads to errors only
app.use(
    '/api/v1/graphql',
    apiV1Auth,
    expressGraphQL({
        schema: apiV1GraphQLSchema,
        rootValue: apiV1GraphQLResolvers,
        graphiql: true,
        formatError(error) {
            if (!error.originalError) return error;
            const code = error.originalError.httpStatusCode;
            const name = error.originalError.name;
            const message = error.originalError.message;
            const data = error.originalError.data;
            return { code, name, message, data };
        }
    })
);

//* Swagger API Documentation
const swaggerDefinition = {
    openapi: '3.0.0',
    info: {
        title: 'nodeJS-graphQL-ecommerce-backend-app',
        version: '1.0.0',
        description: 'nodeJS-graphQL-ecommerce-backend-app',
        termsOfService: 'nodeJS-graphQL-ecommerce-backend-app - TOS',
        host: 'http://localhost:3500',
        basePath: '/api',
        schemes: ['http', 'https'],
        license: {
            name: 'MIT',
            url: 'https://choosealicense.com/licenses/mit/'
        },
        contact: {
            name: 'Burhanuddin Bhopalwala',
            url: 'https://github.com/burhanuddinbhopalwala',
            email: 'burhanuddinbhopalwala.connect@gmail.com'
        }
    },
    servers: [
        {
            url: 'http://localhost:3500',
            description: 'dev'
        }
    ],
    components: {
        schemas: {},
        securitySchemes: {
            authHeader: {
                type: 'http', //* http, apiKey, oauth2 or openIdConnect
                scheme: 'bearer',
                bearerFormat: 'JWT'
            }
        }
    }
};
const options = {
    swaggerDefinition,
    apis: ['./models/*.js', './routes/*.js', './swaggerComponents/*.js']
};
const swaggerSpec = swaggerJsDoc(options);

app.get('/swagger.json', function(req, res) {
    res.setHeader('Content-Type', 'application/json');
    res.send(swaggerSpec);
});
app.use(
    '/api/v1/api-docs',
    swaggerUiExpress.serve,
    swaggerUiExpress.setup(swaggerSpec)
);
/*
 * Swagger ref links:
 * https://itnext.io/setting-up-swagger-in-a-node-js-application-d3c4d7aa56d4
 * https://scotch.io/tutorials/speed-up-your-restful-api-development-in-node-js-with-swagger
 * https://levelup.gitconnected.com/the-simplest-way-to-add-swagger-to-a-node-js-project-c2a4aa895a3c
 */

//* Scheduling master jobs
masterJobs.runMasterJobs();

//* Error handling
app.use(errorHandlingRoutes);

//* Sequelize sync
sequelize
    .sync({ force: false })
    .then(data => {
        console.log('MySQL sync successful!');
        app.listen(PORT, () =>
            console.log(`Listening and serving HTTP on :${PORT}`)
        );
    })
    .catch(err => {
        console.log(err);
    });
